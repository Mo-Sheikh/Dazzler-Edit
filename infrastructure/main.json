{
  "Description": "A BBC Component template for Dazzler Edit. Includes autoscaled instances",
  "AWSTemplateFormatVersion": "2010-09-09",
  "Resources": {
    "ComponentScalingPolicy": {
      "Type": "AWS::AutoScaling::ScalingPolicy",
      "Properties": {
        "ScalingAdjustment": 1,
        "AutoScalingGroupName": {
          "Ref": "ComponentAutoScalingGroup"
        },
        "AdjustmentType": "ChangeInCapacity"
      }
    },
    "ComponentAutoScalingGroup": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "HealthCheckGracePeriod": 300,
        "Tags": [{
            "Key": "BBCEnvironment",
            "Value": {
              "Ref": "Environment"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "Name",
            "Value": {
              "Fn::Join": [
                "",
                [{
                    "Ref": "Environment"
                  },
                  {
                    "Ref": "Component"
                  }
                ]
              ]
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BBCComponent",
            "Value": {
              "Ref": "Component"
            },
            "PropagateAtLaunch": true
          },
          {
            "Key": "BBCProject",
            "PropagateAtLaunch": true,
            "Value": "ws-dazzler"
          }
        ],
        "LaunchConfigurationName": {
          "Ref": "ComponentLaunchConfiguration"
        },
        "MinSize": {
          "Ref": "MinSize"
        },
        "MaxSize": {
          "Ref": "MaxSize"
        },
        "VPCZoneIdentifier": [{
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-PrivateSubnet0"
            }
          },
          {
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-PrivateSubnet1"
            }
          },
          {
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-PrivateSubnet2"
            }
          }
        ],
        "LoadBalancerNames": [{
          "Ref": "ComponentElasticLoadBalancer"
        }],
        "AvailabilityZones": ["eu-west-1a", "eu-west-1b", "eu-west-1c"],
        "HealthCheckType": "ELB"
      },
      "UpdatePolicy": {
        "AutoScalingRollingUpdate": {
          "PauseTime": {
            "Ref": "UpdatePauseTime"
          },
          "MaxBatchSize": {
            "Ref": "UpdateMaxBatchSize"
          },
          "MinInstancesInService": {
            "Ref": "UpdateMinInService"
          }
        }
      }
    },
    "ComponentElasticLoadBalancer": {
      "Type": "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties": {
        "HealthCheck": {
          "HealthyThreshold": "3",
          "Interval": "15",
          "Target": "HTTP:7080/status/",
          "Timeout": "10",
          "UnhealthyThreshold": "3"
        },
        "Listeners": [{
          "InstancePort": "7443",
          "LoadBalancerPort": "443",
          "Protocol": "tcp",
          "InstanceProtocol": "tcp"
        }],
        "SecurityGroups": [{
          "Ref": "LoadBalancerSecurityGroup"
        }],
        "Subnets": [{
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-PublicSubnet0"
            }
          },
          {
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-PublicSubnet1"
            }
          },
          {
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-PublicSubnet2"
            }
          }
        ]
      }
    },
    "ComponentLaunchConfiguration": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "KeyName": {
          "Ref": "KeyName"
        },
        "SecurityGroups": [{
            "Fn::ImportValue": {
              "Fn::Sub": "${CoreInfrastructureStackName}-SSHFromBastionsSecGroup"
            }
          },
          {
            "Ref": "ComponentSecurityGroup"
          }
        ],
        "InstanceType": {
          "Ref": "InstanceType"
        },
        "IamInstanceProfile": {
          "Ref": "ComponentInstanceProfile"
        },
        "ImageId": {
          "Ref": "ImageId"
        }
      }
    },
    "ComponentInstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [{
          "Ref": "ComponentRole"
        }]
      }
    },
    "LoadBalancerSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "An ELB group allowing access only to from the corresponding component",
        "SecurityGroupIngress": [{
          "ToPort": "443",
          "FromPort": "443",
          "IpProtocol": "tcp",
          "CidrIp": "0.0.0.0/0"
        }],
        "VpcId": {
          "Fn::ImportValue": {
            "Fn::Sub": "${CoreInfrastructureStackName}-VpcId"
          }
        }
      }
    },
    "ComponentDNS": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneName": {
          "Fn::FindInMap": ["OperationsMap", "DomainNameBaseMap", {
            "Ref": "Environment"
          }]
        },
        "Name": {
          "Fn::Join": [
            ".",
            [{
                "Fn::FindInMap": ["OperationsMap", "CnameEntryMap", {
                  "Ref": "Environment"
                }]
              },
              {
                "Fn::FindInMap": ["OperationsMap", "DomainNameBaseMap", {
                  "Ref": "Environment"
                }]
              }
            ]
          ]
        },
        "Type": "CNAME",
        "ResourceRecords": [{
          "Fn::GetAtt": ["ComponentElasticLoadBalancer", "DNSName"]
        }],
        "TTL": "60"
      }
    },
    "ComponentPolicy": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyName": "ComponentPolicy",
        "PolicyDocument": {
          "Statement": [{
              "Action": ["sts:AssumeRole"],
              "Resource": ["*"],
              "Effect": "Allow"
            },
            {
              "Action": ["cloudwatch:PutMetricData"],
              "Resource": ["*"],
              "Effect": "Allow"
            },
            {
              "Action": [
                "sqs:DeleteMessage",
                "sqs:SendMessage",
                "sqs:ReceiveMessage"
              ],
              "Resource": {
                "Fn::GetAtt": ["captureTaskQueue", "Arn"]
              },
              "Effect": "Allow"
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:GetObject",
                "s3:GetObjectAcl",
                "s3:GetObjectVersion",
                "s3:PutObject",
                "s3:PutObjectAcl",
                "s3:DeleteObject",
                "s3:DeleteObjectTagging",
                "s3:DeleteObjectVersionTagging",
                "s3:GetObjectTagging",
                "s3:GetObjectVersionTagging",
                "s3:PutObjectTagging",
                "s3:PutObjectVersionTagging"
              ],
              "Resource": [
                {
                  "Fn::Sub": ["arn:aws:s3:::${bucketName}/*",
                    { "bucketName": {
                        "Fn::FindInMap": ["OperationsMap", "PlayoutBucketMap", { "Ref": "Environment" } ]
                      }
                    }
                  ]
                }
              ]
            },
            {
              "Effect": "Allow",
              "Action": [
                "s3:ListBucket",
                "s3:GetBucketLocation",
                "s3:GetLifecycleConfiguration"
              ],
              "Resource": [
                {
                  "Fn::Sub": ["arn:aws:s3:::${bucketName}",
                    { "bucketName": {
                        "Fn::FindInMap": ["OperationsMap", "PlayoutBucketMap", { "Ref": "Environment" } ]
                      }
                    }
                  ]
                }
              ]
            },
            {
              "Action": [
                "s3:GetBucketLocation",
                "s3:GetBucketNotification",
                "s3:GetObject",
                "s3:ListBucket",
                "s3:ListBucketMultipartUploads",
                "s3:ListMultipartUploadParts"
              ],
              "Resource": [{
                "Ref": "S3BucketArn"
              }],
              "Effect": "Allow"
            },
            {
              "Action": [
                "s3:GetObject",
                "s3:GetBucketLocation",
                "s3:AbortMultipartUpload",
                "s3:PutBucketNotification",
                "s3:PutObject",
                "s3:DeleteObject"
              ],
              "Resource": [{
                "Fn::Join": ["", [
                  { "Ref": "S3BucketArn" }, "/",
                  { "Ref": "Component" }, "/", 
                  { "Ref": "Environment" }, "/logs/*"]
                ]
              }],
              "Effect": "Allow"
            },
            {
              "Action": ["cloudformation:Describe*"],
              "Resource": ["*"],
              "Effect": "Allow"
            },
            {
              "Action": ["ec2:Describe*"],
              "Resource": ["*"],
              "Effect": "Allow"
            },
            {
              "Action": ["tag:GetResources"],
              "Resource": ["*"],
              "Effect": "Allow"
            }
          ]
        },
        "Roles": [{
          "Ref": "ComponentRole"
        }]
      }
    },
    "ComponentSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "SecurityGroupIngress": [{
            "SourceSecurityGroupId": {
              "Ref": "LoadBalancerSecurityGroup"
            },
            "FromPort": "7080",
            "ToPort": "7080",
            "IpProtocol": "tcp"
          },
          {
            "SourceSecurityGroupId": {
              "Ref": "LoadBalancerSecurityGroup"
            },
            "FromPort": "7443",
            "ToPort": "7443",
            "IpProtocol": "tcp"
          },
          {
            "SourceSecurityGroupId": {
              "Ref": "LoadBalancerSecurityGroup"
            },
            "FromPort": "123",
            "ToPort": "123",
            "IpProtocol": "udp"
          }
        ],
        "VpcId": {
          "Fn::ImportValue": {
            "Fn::Sub": "${CoreInfrastructureStackName}-VpcId"
          }
        },
        "GroupDescription": "A component security group allowing access only from the corresponding ELB"
      }
    },
    "ComponentRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "Path": "/",
        "AssumeRolePolicyDocument": {
          "Statement": [{
            "Action": ["sts:AssumeRole"],
            "Effect": "Allow",
            "Principal": {
              "Service": ["ec2.amazonaws.com"]
            }
          }]
        }
      }
    },
    "captureTaskQueue": {
      "Type": "AWS::SQS::Queue",
      "Properties": {
        "QueueName": {
          "Fn::Join": ["-", [{
            "Ref": "Environment"
          }, "dazzler-capture-tasks.fifo"]]
        },
        "FifoQueue": true,
        "ContentBasedDeduplication": true,
        "Tags": [{
          "Key": "Purpose",
          "Value": "captureTasks"
        }]
      }
    },
    "captureTaskQueuePolicy": {
      "Type": "AWS::SQS::QueuePolicy",
      "Properties": {
        "PolicyDocument": {
          "Version": "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": "*",
            "Action": "sqs:sendMessage",
            "Resource": {
              "Fn::GetAtt": ["captureTaskQueue", "Arn"]
            }
          }]
        },
        "Queues": [{
          "Fn::GetAtt": ["captureTaskQueue", "QueueName"]
        }]
      }
    }
  },
  "Parameters": {
    "Component": {
      "Default": "ws-dazzler-edit",
      "Type": "String",
      "Description": "The name of the Cosmos Component"
    },
    "MinSize": {
      "Default": "1",
      "Type": "String",
      "Description": "The minimum number of instances"
    },
    "UpdatePauseTime": {
      "Default": "PT0S",
      "Type": "String",
      "Description": "The time to wait between new instances coming online and the next batch being killed during an ASG update."
    },
    "UpdateMinInService": {
      "Default": "0",
      "Type": "String",
      "Description": "The minimum number of instances in service during an ASG update."
    },
    "MaxSize": {
      "Default": "1",
      "Type": "String",
      "Description": "The maximum number of instances"
    },
    "ImageId": {
      "Default": "ami-9398d3e0",
      "Type": "String",
      "Description": "The AMI to use for this component"
    },
    "Environment": {
      "Default": "test",
      "ConstraintDescription": "Values must be test or live",
      "Type": "String",
      "Description": "The deployment environment",
      "AllowedValues": [
        "test",
        "live"
      ]
    },
    "KeyName": {
      "Default": "cosmos",
      "Type": "String",
      "Description": "Name of existing EC2 keypair to enable SSH access to the created instances"
    },
    "S3BucketArn": {
      "Default": "arn:aws:s3:::dazzleredit",
      "Type": "String",
      "Description": "The location of the default private storage bucket for all applications."
    },
    "UpdateMaxBatchSize": {
      "Default": "1",
      "Type": "String",
      "Description": "The maximum number of instances to be killed at one time during an ASG update."
    },
    "InstanceType": {
      "Default": "t2.micro",
      "Type": "String",
      "Description": "The size of the instances"
    },
    "CoreInfrastructureStackName": {
      "Default": "core-infrastructure",
      "Type": "String",
      "Description": "Name of the AWS account's core-infrastructure stack. Used to import other network parameters (vpc id, subnets etc)"
    }
  },
  "Mappings": {
    "OperationsMap": {
      "DomainNameBaseMap": {
        "live": "7a576ea3ed7ca599.xhst.bbci.co.uk.",
        "test": "1c9eb4db7739eb1a.xhst.bbci.co.uk."
      },
      "CnameEntryMap": {
        "live": "dazzler",
        "test": "dazzler.test"
      },
      "VpcCidrIpMap": {
        "live": "10.124.64.0/18",
        "test": "10.98.0.0/18"
      },
      "PlayoutBucketMap": {
        "live": "ws-dazzler-assets",
        "test": "ws-dazzler-assets-test"
      },
      "ElasticSearchMap": {
        "live": "vpc-live-pws-es-01-sharq3wijppafqfq2v3isa5ram.eu-west-1.es.amazonaws.com",
        "test": "vpc-test-pws-es-01-ntq5eu3xhbkw56fc2yi4vt2ndm.eu-west-1.es.amazonaws.com"
      }
    }
  }
}